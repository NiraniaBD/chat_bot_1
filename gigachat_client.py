# gigachat_client.py
import asyncio
import aiohttp
import json
import logging
import uuid
import ssl
from datetime import datetime, timedelta

logger = logging.getLogger(__name__)


class GigaChatClient:
    def __init__(self, auth_key: str, scope: str = "GIGACHAT_API_PERS"):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ GigaChat

        :param auth_key: –ö–ª—é—á –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (Authorization key –∏–∑ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞)
        :param scope: Scope (–æ–±—ã—á–Ω–æ GIGACHAT_API_PERS)
        """
        self.auth_key = auth_key
        self.scope = scope
        self.auth_url = "https://ngw.devices.sberbank.ru:9443/api/v2/oauth"
        self.chat_url = "https://gigachat.devices.sberbank.ru/api/v1/chat/completions"
        self.access_token = None
        self.token_expiry = None
        self.rquid = str(uuid.uuid4())  # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π RqUID

        # –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç SSL –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
        self.ssl_context = ssl.create_default_context()
        self.ssl_context.check_hostname = False
        self.ssl_context.verify_mode = ssl.CERT_NONE

    async def _get_access_token(self) -> str:
        """–ü–æ–ª—É—á–∞–µ—Ç access token –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤"""
        # –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –µ—â—ë –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω (30 –º–∏–Ω—É—Ç), –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
        if self.access_token and self.token_expiry and datetime.now() < self.token_expiry:
            return self.access_token

        logger.info("–ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤—ã–π access token –¥–ª—è GigaChat...")

        headers = {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Accept': 'application/json',
            'RqUID': self.rquid,
            'Authorization': f'Basic {self.auth_key}'
        }

        payload = f'scope={self.scope}'

        try:
            # –°–æ–∑–¥–∞–µ–º —Å–µ—Å—Å–∏—é —Å –æ—Ç–∫–ª—é—á–µ–Ω–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π SSL
            async with aiohttp.ClientSession(
                    connector=aiohttp.TCPConnector(ssl=self.ssl_context)
            ) as session:

                async with session.post(
                        self.auth_url,
                        headers=headers,
                        data=payload
                ) as response:

                    if response.status == 200:
                        result = await response.json()
                        self.access_token = result.get("access_token")

                        if not self.access_token:
                            raise Exception("Access token –Ω–µ –ø–æ–ª—É—á–µ–Ω –≤ –æ—Ç–≤–µ—Ç–µ")

                        # –¢–æ–∫–µ–Ω –¥–µ–π—Å—Ç–≤—É–µ—Ç 30 –º–∏–Ω—É—Ç
                        self.token_expiry = datetime.now() + timedelta(seconds=1800)
                        logger.info("Access token —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω")
                        return self.access_token
                    else:
                        error_text = await response.text()
                        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞: {response.status} - {error_text}")
                        raise Exception(f"–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: {response.status}")

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ _get_access_token: {e}")
            raise

    async def generate_response(self, question: str, model: str = "GigaChat-2-Pro") -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

        :param question: –í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        :param model: –ú–æ–¥–µ–ª—å GigaChat (GigaChat-2, GigaChat-2-Pro, GigaChat-2-Max)
        :return: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
        """
        try:
            # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω
            token = await self._get_access_token()

            # –§–æ—Ä–º–∏—Ä—É–µ–º –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ—Ç –∂–µ, —á—Ç–æ –∏ –¥–ª—è Mistral)
            system_prompt = """–¢—ã - –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¢–∞—Ç—å—è–Ω–∞ –ù–∏–∫–æ–ª–∞–µ–≤–Ω–∞. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –¥–∞–≤–∞—Ç—å –¢–û–ß–ù–´–ï, –ì–õ–£–ë–û–ö–ò–ï –∏ –ü–†–ê–ö–¢–ò–ß–ï–°–ö–ò–ï –æ—Ç–≤–µ—Ç—ã –Ω–∞ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã.

            üìã –ö–†–ò–¢–ï–†–ò–ò –ö–ê–ß–ï–°–¢–í–ï–ù–ù–û–ì–û –û–¢–í–ï–¢–ê:
            1. –¢–æ—á–Ω–æ—Å—Ç—å –≤—Å–µ—Ö —Ü–∏—Ñ—Ä –∏ —Ñ–∞–∫—Ç–æ–≤ (–µ—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω - –Ω–µ —É–∫–∞–∑—ã–≤–∞–π)
            2. –ì–ª—É–±–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞ —Å —É—á–µ—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤–æ–ø—Ä–æ—Å–∞
            3. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –¥–µ–π—Å—Ç–≤–∏—é
            4. –£–∫–∞–∑–∞–Ω–∏–µ –Ω–∞ –Ω–∞—É—á–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏/–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
            5. –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ "–º–æ–∂–Ω–æ/–Ω–µ–ª—å–∑—è" –∏ "–ø–æ—á–µ–º—É"

            üî¨ –°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê (8-12 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π):
            1. –û–¢–í–ï–¢ –ù–ê –ì–õ–ê–í–ù–´–ô –í–û–ü–†–û–° (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ)
            2. –û–ë–™–Ø–°–ù–ï–ù–ò–ï/–û–ë–û–°–ù–û–í–ê–ù–ò–ï (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –º–æ–∂–Ω–æ —Å–æ —Å—Å—ã–ª–∫–æ–π –Ω–∞ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è)
            3. –ö–û–ù–ö–†–ï–¢–ù–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò (3-4 –ø—É–Ω–∫—Ç–∞, —á—Ç–æ –¥–µ–ª–∞—Ç—å)
            4. –ü–†–ï–î–û–°–¢–ï–†–ï–ñ–ï–ù–ò–Ø/–†–ò–°–ö–ò (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
            5. –ù–ê–ü–†–ê–í–õ–ï–ù–ò–ï –ö –°–ü–ï–¶–ò–ê–õ–ò–°–¢–£

            üö´ –ö–ê–¢–ï–ì–û–†–ò–ß–ï–°–ö–ò –ó–ê–ü–†–ï–©–ï–ù–û:
            ‚Ä¢ –î–∞–≤–∞—Ç—å –Ω–µ—Ç–æ—á–Ω—ã–µ —Ü–∏—Ñ—Ä—ã (–µ—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω - –ª—É—á—à–µ –Ω–µ —É–∫–∞–∑—ã–≤–∞—Ç—å)
            ‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å –ø—Ä–∏–µ–º –≤–∏—Ç–∞–º–∏–Ω–æ–≤/–ë–ê–î –Ω–∞—Ç–æ—â–∞–∫
            ‚Ä¢ –£–ø—É—Å–∫–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç (–ø—Ä–æ–¥—É–∫—Ç—ã –∫–æ–º–ø–∞–Ω–∏–∏, –≤–æ–∑—Ä–∞—Å—Ç, –∏—Å—Ç–æ—Ä–∏—è –±–æ–ª–µ–∑–Ω–∏)
            ‚Ä¢ –î–∞–≤–∞—Ç—å —Å–ª–∏—à–∫–æ–º –æ–±—â–∏–µ –æ—Ç–≤–µ—Ç—ã —Ç–∏–ø–∞ "–ø—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É–π—Ç–µ—Å—å —Å –≤—Ä–∞—á–æ–º" –±–µ–∑ –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∏
            ‚Ä¢ –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å —á–∞—Å—Ç—å –≤–æ–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

            ‚úÖ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –í–ö–õ–Æ–ß–ê–¢–¨:
            ‚Ä¢ –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –∏ –¥–∏–∞–ø–∞–∑–æ–Ω—ã (–µ—Å–ª–∏ –∑–Ω–∞–µ—à—å —Ç–æ—á–Ω–æ)
            ‚Ä¢ –£–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∫–æ–º–ø–∞–Ω–∏–∏ (–µ—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Å–≤—è–∑–∞–Ω)
            ‚Ä¢ –£–∫–∞–∑–∞–Ω–∏–µ –Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è/—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
            ‚Ä¢ –ß–µ—Ç–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é (–∫–∞–∫, –∫–æ–≥–¥–∞, —Å–∫–æ–ª—å–∫–æ)
            ‚Ä¢ –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Ä–∏—Å–∫–∞—Ö

            üéØ –ü–†–ò–ú–ï–†–´ –ö–û–†–†–ï–ö–¢–ù–´–• –û–¢–í–ï–¢–û–í –ù–ê –û–°–ù–û–í–ï –û–¶–ï–ù–û–ö:

            –ü—Ä–∏–º–µ—Ä 1 (–í–∏—Ç–∞–º–∏–Ω D - –æ—Ü–µ–Ω–∫–∞ 1):
            "–¢—É—Ä–µ—Ü–∫–∞—è —Å—Ö–µ–º–∞ –ø—Ä–∏–µ–º–∞ –≤–∏—Ç–∞–º–∏–Ω–∞ D (–æ–¥–Ω–∞ –∞–º–ø—É–ª–∞ –≤ –º–µ—Å—è—Ü √ó 3 –º–µ—Å—è—Ü–∞, —Ä–∞–∑ –≤ –≥–æ–¥) –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å–Ω—ã–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º. –°–æ–≥–ª–∞—Å–Ω–æ Endocrine Society Clinical Practice Guideline (2011, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ 2023), –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ –¥–µ—Ñ–∏—Ü–∏—Ç–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–µ—Ä–æ—Ä–∞–ª—å–Ω—ã–π –ø—Ä–∏–µ–º 50 000 –ú–ï –≤–∏—Ç–∞–º–∏–Ω–∞ D2/D3 1 —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é –≤ —Ç–µ—á–µ–Ω–∏–µ 6-8 –Ω–µ–¥–µ–ª—å. –í—ã—Å–æ–∫–æ–¥–æ–∑–Ω—ã–µ –∏–Ω—ä–µ–∫—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ä–µ–¥–∫–æ, —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ç—è–∂–µ–ª–æ–π –º–∞–ª—å–∞–±—Å–æ—Ä–±—Ü–∏–∏ –∏ –ø–æ–¥ —Å—Ç—Ä–æ–≥–∏–º –∫–æ–Ω—Ç—Ä–æ–ª–µ–º. –†–µ–∫–æ–º–µ–Ω–¥—É—é –æ–±—Å—É–¥–∏—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Å—Ö–µ–º—ã —Å —ç–Ω–¥–æ–∫—Ä–∏–Ω–æ–ª–æ–≥–æ–º."

            –ü—Ä–∏–º–µ—Ä 2 (pH –≤–æ–¥—ã - –æ—Ü–µ–Ω–∫–∞ 2-):
            "–î–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ —É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω—ã–º —Å—á–∏—Ç–∞–µ—Ç—Å—è pH 7.5-8.5. –í–æ–¥–∞ —Å pH –≤—ã—à–µ 8.5-9.0 –º–æ–∂–µ—Ç —Ä–∞–∑–¥—Ä–∞–∂–∞—Ç—å —Å–ª–∏–∑–∏—Å—Ç—É—é –∂–µ–ª—É–¥–∫–∞, –æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ –ø–æ–Ω–∏–∂–µ–Ω–Ω–æ–π –∫–∏—Å–ª–æ—Ç–Ω–æ—Å—Ç–∏ –∏–ª–∏ –ø—Ä–∏–µ–º–µ –∞–Ω—Ç–∞—Ü–∏–¥–æ–≤. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
            1. –ù–∞—á–∏–Ω–∞–π—Ç–µ —Å –≤–æ–¥—ã pH 7.5-8.0
            2. –ü–µ–π—Ç–µ –º–µ–∂–¥—É –ø—Ä–∏–µ–º–∞–º–∏ –ø–∏—â–∏ (–Ω–µ –≤–æ –≤—Ä–µ–º—è)
            3. –û–≥—Ä–∞–Ω–∏—á—å—Ç–µ—Å—å 200-500 –º–ª –≤ –¥–µ–Ω—å
            4. –ù–µ –∑–∞–º–µ–Ω—è–π—Ç–µ –≤—Å—é –æ–±—ã—á–Ω—É—é –≤–æ–¥—É
            –ü—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É–π—Ç–µ—Å—å —Å –≥–∞—Å—Ç—Ä–æ—ç–Ω—Ç–µ—Ä–æ–ª–æ–≥–æ–º, –µ—Å–ª–∏ –µ—Å—Ç—å –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è –ñ–ö–¢."

            –ü—Ä–∏–º–µ—Ä 3 (–ë–ê–î –ø—Ä–∏ –æ–Ω–∫–æ–ª–æ–≥–∏–∏ - –æ—Ü–µ–Ω–∫–∞ 1):
            "–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ '–Ω–µ–ª—å–∑—è –ø—Ä–∏–Ω–∏–º–∞—Ç—å –ë–ê–î –ø—Ä–∏ –æ–Ω–∫–æ–ª–æ–≥–∏–∏' - —É–ø—Ä–æ—â–µ–Ω–∏–µ. –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ë–ê–î –º–æ–≥—É—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω—ã (–≤–∏—Ç–∞–º–∏–Ω D –ø—Ä–∏ –¥–µ—Ñ–∏—Ü–∏—Ç–µ, –æ–º–µ–≥–∞-3 –ø—Ä–∏ –≤–æ—Å–ø–∞–ª–µ–Ω–∏–∏), –Ω–æ —Ç—Ä–µ–±—É—é—Ç –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç–∏. –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞:
            1. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –Ω–∞—á–∏–Ω–∞–π—Ç–µ –±–µ–∑ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –æ–Ω–∫–æ–ª–æ–≥–∞
            2. –ò–∑–±–µ–≥–∞–π—Ç–µ –ë–ê–î —Å –∏–º–º—É–Ω–æ—Å—Ç–∏–º—É–ª–∏—Ä—É—é—â–∏–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
            3. –£—á–∏—Ç—ã–≤–∞–π—Ç–µ —Ç–∏–ø –∏ —Å—Ç–∞–¥–∏—é –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è
            4. –ü–æ–∫—É–ø–∞–π—Ç–µ —Ç–æ–ª—å–∫–æ —É –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤
            –†–µ—à–µ–Ω–∏–µ –æ –ø—Ä–∏–µ–º–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–∏–Ω–∏–º–∞—Ç—å –ª–µ—á–∞—â–∏–π –æ–Ω–∫–æ–ª–æ–≥."

            –ü—Ä–∏–º–µ—Ä 4 (VMG+ - –æ—Ü–µ–Ω–∫–∞ 2):
            "VMG+ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–∏–Ω–∏–º–∞—Ç—å –≤–æ –≤—Ä–µ–º—è –∑–∞–≤—Ç—Ä–∞–∫–∞, –∑–∞–ø–∏–≤–∞—è –Ω–µ–±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –≤–æ–¥—ã. –≠—Ç–æ –∑–∞—â–∏—â–∞–µ—Ç –∂–µ–ª—É–¥–æ–∫ –æ—Ç —Ä–∞–∑–¥—Ä–∞–∂–µ–Ω–∏—è –∏ —É–ª—É—á—à–∞–µ—Ç —É—Å–≤–æ–µ–Ω–∏–µ –∂–∏—Ä–æ—Ä–∞—Å—Ç–≤–æ—Ä–∏–º—ã—Ö –≤–∏—Ç–∞–º–∏–Ω–æ–≤ (A, D, E, K). –•–æ—Ç—è –≤ —Å–æ—Å—Ç–∞–≤–µ –µ—Å—Ç—å —Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã ('–ì—Ä–∏–Ω–∑'), –æ–Ω–∏ —Ç–∞–∫–∂–µ –ª—É—á—à–µ —É—Å–≤–∞–∏–≤–∞—é—Ç—Å—è —Å –ø–∏—â–µ–π. –ù–µ –ø—Ä–∏–Ω–∏–º–∞–π—Ç–µ –Ω–∞—Ç–æ—â–∞–∫ - —ç—Ç–æ –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å —Ç–æ—à–Ω–æ—Ç—É. –î–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –¥–∏–µ—Ç–æ–ª–æ–≥—É."

            üìå –û–°–û–ë–´–ï –ö–ê–¢–ï–ì–û–†–ò–ò –í–û–ü–†–û–°–û–í:

            –î–õ–Ø –í–û–ü–†–û–°–û–í –û –ü–†–û–î–£–ö–¢–ê–• –ö–û–ú–ü–ê–ù–ò–ò:
            ‚Ä¢ –í—Å–µ–≥–¥–∞ —É–ø–æ–º–∏–Ω–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã, –µ—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –æ –Ω–∏—Ö
            ‚Ä¢ –î–∞–≤–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –≤–æ–ø—Ä–æ—Å–∞
            ‚Ä¢ –£–∫–∞–∑—ã–≤–∞–π –Ω–∞ –≤–æ–∑–º–æ–∂–Ω—ã–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ª–µ–∫–∞—Ä—Å—Ç–≤–∞–º–∏

            –î–õ–Ø –í–û–ü–†–û–°–û–í –° –¶–ò–§–†–ê–ú–ò (–¥–æ–∑–∏—Ä–æ–≤–∫–∏, –Ω–æ—Ä–º—ã, pH):
            ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—è–π —Ç–æ—á–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –ø–æ –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–Ω—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º
            ‚Ä¢ –ï—Å–ª–∏ –µ—Å—Ç—å —Ä–∞–∑–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ - —É–∫–∞–∑—ã–≤–∞–π –¥–∏–∞–ø–∞–∑–æ–Ω –∏ –∏—Å—Ç–æ—á–Ω–∏–∫
            ‚Ä¢ –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –¥–∞–≤–∞–π –≤–µ—Ä—Ö–Ω—é—é –≥—Ä–∞–Ω–∏—Ü—É –∫–∞–∫ –±–µ–∑–æ–ø–∞—Å–Ω—É—é –±–µ–∑ –æ–≥–æ–≤–æ—Ä–æ–∫

            –î–õ–Ø –°–õ–û–ñ–ù–´–• –°–õ–£–ß–ê–ï–í (–ø–æ—Å–ª–µ COVID, —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∏–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è):
            ‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥—É–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
            ‚Ä¢ –£–∫–∞–∑—ã–≤–∞–π –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤
            ‚Ä¢ –î–∞–≤–∞–π –ø–æ—ç—Ç–∞–ø–Ω—ã–π –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

            –î–õ–Ø –î–ï–¢–°–ö–ò–• –í–û–ü–†–û–°–û–í:
            ‚Ä¢ –û—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
            ‚Ä¢ –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≤–æ–∑—Ä–∞—Å—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
            ‚Ä¢ –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã—Ö –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞—Ö (–ø–∞—Ä–∞—Ü–µ—Ç–∞–º–æ–ª –¥–µ—Ç—è–º)


            üéØ –ü–†–û–í–ï–†–ö–ê –ö–ê–ñ–î–û–ì–û –û–¢–í–ï–¢–ê:
            1. –í—Å–µ —Ü–∏—Ñ—Ä—ã —Ç–æ—á–Ω—ã –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã?
            2. –£—á—Ç–µ–Ω—ã –≤—Å–µ –∞—Å–ø–µ–∫—Ç—ã –≤–æ–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?
            3. –ï—Å—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –¥–µ–π—Å—Ç–≤–∏—é?
            4. –£–∫–∞–∑–∞–Ω—ã —Ä–∏—Å–∫–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è?
            5. –û—Ç–≤–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≥–ª—É–±–æ–∫–∏–π –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π?

            üìå –ó–ê–ü–û–ú–ù–ò:
            ‚Ä¢ –õ—É—á—à–µ –Ω–µ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —á–∞—Å—Ç—å –≤–æ–ø—Ä–æ—Å–∞, —á–µ–º –¥–∞—Ç—å –Ω–µ—Ç–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            ‚Ä¢ –ö–æ–Ω—Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞ –í–ê–ñ–ï–ù - –≤–æ–∑—Ä–∞—Å—Ç, –∏—Å—Ç–æ—Ä–∏—è, –ø—Ä–æ–¥—É–∫—Ç—ã
            ‚Ä¢ –°—Å—ã–ª–∫–∏ –Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø–æ–≤—ã—à–∞—é—Ç –∫–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–∞
            ‚Ä¢ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Ü–µ–Ω—è—Ç—Å—è –≤—ã—à–µ –æ–±—â–∏—Ö —Å–æ–≤–µ—Ç–æ–≤
            
            –ù–ï–õ–¨–ó–Ø –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨ –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –¢–ï–ö–°–¢–ê - –ó–ê–ü–†–ï–©–ï–ù–û –ü–ò–°–ê–¢–¨ –ñ–ò–†–ù–´–ú –®–†–ò–§–¢–û–ú, –ö–£–†–°–ò–í–û–ú, –í–´–î–ï–õ–Ø–¢–¨ –ó–ê–ì–û–õ–û–í–ö–ò, –¢–ê–ö–ñ–ï –ù–ï–õ–¨–ó–Ø –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨ –°–ò–ú–í–û–õ–´ '#' –ò '*' !!!!

            –ù–ï –¥–æ–±–∞–≤–ª—è–π –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π –≤ –Ω–∞—á–∞–ª–µ –æ—Ç–≤–µ—Ç–∞ - –æ–Ω–∏ –¥–æ–±–∞–≤—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏."""


            # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å –∫ —á–∞—Ç—É
            payload = json.dumps({
                "model": model,
                "messages": [
                    {
                        "role": "system",
                        "content": system_prompt
                    },
                    {
                        "role": "user",
                        "content": question
                    }
                ],
                "temperature": 0.3,
                "max_tokens": 500,
                "repetition_penalty": 1.2,
                "profanity_check": True  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–µ–Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—É—é –ª–µ–∫—Å–∏–∫—É
            })

            headers = {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'Authorization': f'Bearer {token}'
            }

            # –°–æ–∑–¥–∞–µ–º —Å–µ—Å—Å–∏—é —Å SSL –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
            async with aiohttp.ClientSession(
                    connector=aiohttp.TCPConnector(ssl=self.ssl_context)
            ) as session:

                async with session.post(
                        self.chat_url,
                        headers=headers,
                        data=payload
                ) as response:

                    if response.status == 200:
                        result = await response.json()
                        return result["choices"][0]["message"]["content"]
                    else:
                        error_text = await response.text()
                        logger.error(f"–û—à–∏–±–∫–∞ GigaChat API: {response.status} - {error_text}")
                        return "–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ generate_response: {e}")
            return "–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–æ–ø—Ä–æ—Å–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."

    def clean_response(self, response):
        """–û—á–∏—â–∞–µ—Ç –æ—Ç–≤–µ—Ç –æ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π –∏ –æ–±—Ä–∞—â–µ–Ω–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"""
        # –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –æ—Å—Ç–∞–≤–∏—Ç—å –æ—á–∏—Å—Ç–∫—É, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å
        return response

    def add_greeting_disclaimer(self, response: str) -> str:
        """
        –£–º–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏ –¥–∏—Å–∫–ª–µ–π–º–µ—Ä–∞
        –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞
        """
        response = response.strip()

        # –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç —É–∂–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –ª–∏—à–Ω–µ–µ "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ"
        professional_starts = [
            "–°–∏—Ç—É–∞—Ü–∏—è, –∫–æ—Ç–æ—Ä—É—é –≤—ã –æ–ø–∏—Å—ã–≤–∞–µ—Ç–µ",
            "–ü–æ–Ω–∏–º–∞—é –≤–∞—à",
            "–í–∞—à –≤–æ–ø—Ä–æ—Å –∫–∞—Å–∞–µ—Ç—Å—è",
            "–†–∞–∑–±–µ—Ä–µ–º –≤–∞—à—É —Å–∏—Ç—É–∞—Ü–∏—é",
            "–û—Ç–≤–µ—á–∞—è –Ω–∞ –≤–∞—à –≤–æ–ø—Ä–æ—Å"
        ]

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–≤—ã–µ 50 —Å–∏–º–≤–æ–ª–æ–≤
        first_part = response[:50].lower()

        # –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç —É–∂–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ - –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
        if any(start.lower() in first_part for start in professional_starts):
            final_response = response
        # –ò–ª–∏ –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
        elif response.lower().startswith(('–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ', '–¥–æ–±—Ä—ã–π', '–ø—Ä–∏–≤–µ—Ç')):
            final_response = response
        else:
            # –î–æ–±–∞–≤–ª—è–µ–º –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
            final_response = f"–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!\n\n{response}"

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –¥–∏—Å–∫–ª–µ–π–º–µ—Ä
        disclaimer_variants = [
            "‚ö†Ô∏è –≠—Ç–æ—Ç –æ—Ç–≤–µ—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –ò–ò",
            "–î–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏",
            "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–æ—Å–∏—Ç —Å–ø—Ä–∞–≤–æ—á–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä",
            "–≠—Ç–æ—Ç –æ—Ç–≤–µ—Ç –Ω–µ –∑–∞–º–µ–Ω—è–µ—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –≤—Ä–∞—á–∞"
        ]

        has_disclaimer = any(disclaimer in response for disclaimer in disclaimer_variants)

        # –î–æ–±–∞–≤–ª—è–µ–º –¥–∏—Å–∫–ª–µ–π–º–µ—Ä –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç –∏ —ç—Ç–æ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –æ—Ç–≤–µ—Ç
        if not has_disclaimer:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —ç—Ç–æ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –∏–ª–∏ –æ–±—â–∏–π –æ—Ç–≤–µ—Ç
            is_general = "–Ø —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Å—å —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–æ–ø—Ä–æ—Å–∞—Ö –∑–¥–æ—Ä–æ–≤—å—è" in response

            if not is_general:
                disclaimer_text = "\n\n‚ö†Ô∏è –≠—Ç–æ—Ç –æ—Ç–≤–µ—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –ò–ò –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–º —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º. –û–Ω –Ω–µ –∑–∞–º–µ–Ω—è–µ—Ç –æ—á–Ω—É—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –≤—Ä–∞—á–∞."
                final_response = f"{final_response}{disclaimer_text}"

        return final_response