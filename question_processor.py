import logging
import re

logger = logging.getLogger(__name__)

class QuestionProcessor:
    """Умный обработчик вопросов с гибкой фильтрацией"""

    def __init__(self):
        # Приветствия для удаления
        self.greetings = [
            "здравствуйте", "добрый день", "добрый вечер", "доброе утро",
            "привет", "доброй ночи", "уважаемая", "уважаемый", "здрасте"
        ]

        # Обращения (могут быть частью вопроса)
        self.addresses = [
            "татьяна", "николаевна", "татьяна николаевна",
            "администратор", "админ", "доктор", "врач", "специалист",
            "эксперт", "консультант"
        ]

        # Ключевые слова и фразы из реальных вопросов (РАСШИРЕНО)
        self.medical_patterns = [
            # Головные боли и неврология (ДОБАВЛЕНО)
            'головн', 'голова', 'мигрен', 'боль голов', 'мигрень',
            'мрт', 'мрт ', 'мрт голов', 'томограф', 'узи голов',
            'мозг', 'мозга', 'сосуд', 'сосуды', 'сосудов',
            'давлен', 'гипертон', 'гипотон', 'давление',
            'головокруж', 'вертиго', 'тошнот', 'рвот',
            'невролог', 'невропатолог', 'неврологи',

            # Онкология и рак (ДОБАВЛЕНО)
            'рак', 'онкологи', 'онкозаболеван', 'опухол', 'новообразова',
            'карцином', 'канцер', 'злокачествен', 'доброкачествен',
            'молочн желез', 'груд', 'маммограф', 'мастопат',
            'простат', 'предстательн', 'пса ', 'psa',
            'биопс', 'гистолог', 'онкомаркер',

            # Эфирные масла и аббревиатуры (ДОБАВЛЕНО И РАСШИРЕНО)
            'эм', ' эм ', 'эфирн', 'масло', 'эфирное масло',
            'эфирные масла', 'ароматерап', 'аромамасло',
            'дотерра', 'dōterra', 'dō terra', 'dō-terra',
            'young living', 'йонг ливинг', 'йан ливинг',
            'диффузор', 'ингаляц', 'аромалампа',
            'защит', 'поддержк', 'поддержать', 'защитить',
            'чем себя защит', 'чем поддерж', 'как защит',

            # Из примеров
            'вит д', 'витамин д', 'витамин d', 'инъекц', 'укол', 'ампул',
            'схем', 'приём', 'прием', 'прокомментир', 'коммент',
            'ph воды', 'щелочн', 'уровен ph', 'ph питьевой',
            'бад', 'бады', 'биодобав', 'добавк',
            'vmg+', 'витаминно-минеральн', 'комплекс', 'завтрак',
            'еда', 'пища', 'желудок', 'голодный',
            'ковид', 'covid', 'легк', 'дыхан', 'кашель', 'свист',
            'сатурац', 'ингалятор', 'кортикостероид',
            'пальмов', 'масло', 'состав', 'детск', 'витамин',
            'гастрит', 'слизист', 'раздражат',
            'десн', 'челюст', 'воспал', 'опух', 'стоматолог',
            'иммунитет', 'аллерг', 'чихан', 'слез', 'сонн',
            'кож', 'дермат', 'шершав', 'трещин', 'атопич',
            'бронхит', 'хроническ', 'мокрот', 'эвкалипт',
            'остеопороз', 'кальц', 'фтор', 'антипаразитар',
            'миом', 'кист', 'яични', 'папиллом', 'маммолог',
            'геморро', 'шишк', 'боль', 'проктолог',
            'орви', 'фарингит', 'температур', 'горл', 'жаропонижающ',

            # Общие медицинские термины
            'болезн', 'заболеван', 'симптом', 'диагноз', 'лечен',
            'терапи', 'профилактик', 'рекомендац', 'совет',
            'что делать', 'как быть', 'можно ли', 'стоит ли',
            'подскажит', 'посоветуйт', 'помогит', 'объяснит',

            # Частые вопросы о продуктах
            'когда принимат', 'как принимат', 'сколько принимат',
            'с чем принимат', 'до еды', 'после еды', 'во время еды',
            'утром', 'вечером', 'днем', 'на ночь',
            'курс', 'длительн', 'продолжительн', 'перерыв',
            'побочн', 'эффект', 'результат', 'действ',

            # Вопросы о взаимодействии
            'вместе с', 'одновременно', 'параллельн', 'сочета',
            'можно ли совмещат', 'можно ли комбинироват',
            'противопоказан', 'ограничен', 'нельзя',

            # Вопросы о дозировках
            'доз', 'количеств', 'сколько', 'мг', 'мл', 'капель',
            'таблетк', 'капсул', 'ложк', 'чайная', 'столовая',

            # Вопросы о возрасте и состояниях
            'ребенк', 'детск', 'взросл', 'пожил', 'женщин',
            'мужчин', 'беременн', 'кормящ', 'кормление',
            'хроническ', 'острый', 'обострен', 'ремиссия',

            # Общие слова поддержки и здоровья
            'здоровь', 'самочувств', 'состоян', 'помочь',
            'улучшить', 'улучшен', 'усилить', 'укрепить',
            'поддерж', 'профилактик', 'предупредить'
        ]

        # Паттерны-триггеры (даже одно слово из этих триггеров делает вопрос медицинским) - РАСШИРЕНО
        self.trigger_patterns = [
            # Головные боли и МРТ
            r'головн(ой|ая|ые)?\s*бол',  # головная боль
            r'\bмрт\b',  # МРТ
            r'мигрен',  # мигрень

            # Онкология
            r'\bрак\b',  # рак
            r'молочн(ой|ых)?\s*желез',  # молочных желез
            r'онкологи',  # онкология
            r'опухол',  # опухоль

            # Эфирные масла и аббревиатуры
            r'\bэм\b',  # ЭМ (эфирные масла)
            r'эфирн(ое|ые)?\s*масл',  # эфирное масло
            r'дотерра',  # dōterra
            r'young\s*living',  # Young Living

            # Общие медицинские
            r'(вит|витамин)[\s\.]*[дd]',  # вит Д, витамин Д
            r'инъекц',  # инъекции
            r'ph[\s\-]*вод',  # ph воды
            r'бад(ы|ов)?\b',  # бад, бады
            r'vmg\+',  # VMG+
            r'ковид|covid',  # ковид
            r'гастрит',  # гастрит
            r'иммунитет',  # иммунитет
            r'аллерг',  # аллергия
            r'дермат',  # дерматит
            r'бронхит',  # бронхит
            r'остеопороз',  # остеопороз
            r'миом',  # миома
            r'геморро',  # геморрой
            r'орви',  # ОРВИ

            # Процедуры и обследования
            r'завтра\s*(иду|ид[её]т|пойду)',  # завтра иду на...
            r'(иду|пойду)\s*на\s*(мрт|узи|анализ)',  # иду на МРТ/УЗИ
            r'чем\s*себя\s*защит',  # чем себя защитить
            r'чем\s*поддерж',  # чем поддержать
        ]

        # Слова-исключения (точно немедицинские)
        self.non_medical = [
            'политик', 'экономик', 'финанс', 'кредит', 'ипотек',
            'юрист', 'адвокат', 'суд', 'закон', 'прав',
            'религи', 'вера', 'бог', 'церков',
            'кинотеатр', 'концерт', 'выставк', 'музей',
            'ремонт квартир', 'строительств дом',
            'автомобиль купить', 'техника бытов',
            'рецепт пирог', 'блюдо праздничн',
            'программирован', 'компьютер', 'смартфон',
            'отдых на море', 'турпутёвк', 'отель'
        ]

        # Контекстные фразы, которые указывают на медицинский вопрос - РАСШИРЕНО
        self.context_phrases = [
            'не могли бы вы', 'прокомментируйте', 'объясните',
            'подскажите пожалуйста', 'посоветуйте',
            'что делать если', 'как быть когда',
            'можно ли принимать', 'стоит ли использовать',
            'какой лучше', 'какая дозировка',
            'чем помочь', 'как справиться',
            'нужны ли исследования', 'к какому врачу',

            # Новые фразы
            'чем себя защитить', 'чем поддержать',
            'завтра иду на', 'после процедуры',
            'перед обследованием', 'во время лечения',
            'сердечно благодарю', 'благодарю за ответ',
            'спасибо за поддержку', 'заранее благодарен',
            'прошу вашего совета', 'жду вашего ответа',
            'что посоветуете', 'как лучше подготовиться'
        ]

        # Медицинские процедуры и обследования
        self.medical_procedures = [
            'мрт', 'узи', 'кт', 'рентген', 'эндоскопия',
            'колоноскопия', 'гастроскопия', 'биопсия',
            'анализ крови', 'анализ мочи', 'томография',
            'маммография', 'флюорография', 'электрокардиограмма'
        ]

    def clean_question(self, question: str) -> str:
        """Очищает вопрос от приветствий, сохраняя суть"""
        original = question
        words = question.split()
        cleaned_words = []

        # Флаг: пропускать ли приветствия (только в начале)
        skip_greetings = True

        for i, word in enumerate(words):
            word_lower = word.lower().strip(' ,:;.!?')

            # Удаляем только явные приветствия в начале
            if skip_greetings:
                is_greeting = False
                for greeting in self.greetings:
                    # Приветствие должно быть отдельным словом или в начале
                    if (greeting == word_lower or
                            word_lower.startswith(greeting + ",") or
                            word_lower.startswith(greeting + "!") or
                            word_lower.startswith(greeting + ".")):
                        is_greeting = True
                        break

                if is_greeting:
                    continue
                else:
                    skip_greetings = False

            # Проверяем, не является ли слово обращением (сохраняем, если оно не отдельное)
            is_address = False
            for address in self.addresses:
                if address == word_lower:
                    is_address = True
                    break

            # Если это отдельное обращение, можно пропустить
            if is_address and len(word_lower) <= 15:  # Только короткие обращения
                continue

            cleaned_words.append(words[i])  # Сохраняем оригинальное написание

        cleaned = ' '.join(cleaned_words)

        # Если после очистки осталась пустая строка
        if not cleaned.strip():
            return original

        # Убираем начальные/концечные знаки препинания
        cleaned = re.sub(r'^[,\:\-\!\?\s]+', '', cleaned)
        cleaned = re.sub(r'[,\:\-\!\?\s]+$', '', cleaned)

        # Первая буква заглавная
        if cleaned:
            cleaned = cleaned[0].upper() + cleaned[1:]

        logger.debug(f"Очистка: '{original[:50]}...' -> '{cleaned[:50]}...'")
        return cleaned

    def is_health_related(self, question: str) -> bool:
        """Гибкая проверка медицинской тематики - УЛУЧШЕННАЯ"""
        question_lower = question.lower()

        # 0. Быстрая проверка: если есть благодарность в конце - это обычно медицинский вопрос
        if any(phrase in question_lower for phrase in ['благодарю', 'спасибо', 'заранее благодар']):
            # Проверим, есть ли хоть что-то медицинское
            medical_terms_in_thanks = 0
            for pattern in self.medical_patterns:
                if pattern in question_lower:
                    medical_terms_in_thanks += 1
                    if medical_terms_in_thanks >= 1:
                        logger.debug(f"Обнаружен медицинский вопрос с благодарностью")
                        return True

        # 1. Проверяем паттерны-триггеры (самый строгий уровень)
        for pattern in self.trigger_patterns:
            if re.search(pattern, question_lower):
                logger.debug(f"Обнаружен триггер-паттерн: {pattern}")
                return True

        # 2. Проверяем наличие медицинских процедур
        for procedure in self.medical_procedures:
            if procedure in question_lower:
                logger.debug(f"Обнаружена медицинская процедура: {procedure}")
                return True

        # 3. Проверяем контекстные фразы
        has_context = False
        for phrase in self.context_phrases:
            if phrase in question_lower:
                has_context = True
                logger.debug(f"Обнаружена контекстная фраза: {phrase}")
                break

        # 4. Проверяем медицинские паттерны
        medical_score = 0
        found_patterns = []
        for pattern in self.medical_patterns:
            if pattern in question_lower:
                medical_score += 1
                found_patterns.append(pattern)
                logger.debug(f"Обнаружен медицинский паттерн: {pattern}")

        # 5. Проверяем исключения
        for non_med in self.non_medical:
            if non_med in question_lower:
                # Но если есть сильный медицинский контекст, всё равно медицинский
                if medical_score < 2:  # Слабый медицинский контекст
                    logger.debug(f"Обнаружено немедицинское слово: {non_med}")
                    return False

        # 6. Логика принятия решения

        # Вариант A: Есть контекстная фраза + хотя бы 1 медицинский паттерн
        if has_context and medical_score >= 1:
            logger.debug(f"Принято по правилу A: контекст + паттерн")
            return True

        # Вариант B: Хотя бы 2 медицинских паттерна
        if medical_score >= 2:
            logger.debug(f"Принято по правилу B: {medical_score} паттернов")
            return True

        # Вариант C: Вопрос содержит знак вопроса и медицинские термины
        if '?' in question and medical_score >= 1:
            logger.debug(f"Принято по правилу C: вопрос с медицинским термином")
            return True

        # Вариант D: Специальные комбинации для частых случаев
        special_combinations = [
            # Головные боли + что-то еще
            (['голов', 'бол'], 2, "головная боль"),
            # Рак + орган
            (['рак', 'желез', 'молочн'], 2, "рак молочных желез"),
            # МРТ + подготовка
            (['мрт', 'защит', 'подготов'], 2, "подготовка к МРТ"),
            # Эфирные масла + здоровье
            (['эм', 'масл', 'здоров'], 2, "эфирные масла для здоровья"),
        ]

        for keywords, threshold, description in special_combinations:
            count = sum(1 for kw in keywords if kw in question_lower)
            if count >= threshold:
                logger.debug(f"Принято по правилу D: {description}")
                return True

        # 7. Специальные случаи из примеров преподавателя
        special_cases = [
            r'#вопрос',  # Хэштег вопроса
            r'вопрос специалисту',  # Явное обращение
            r'подскажите.*пожалуйста',  # Вежливый запрос
            r'посоветуйте.*чем',  # Запрос совета
            r'завтра иду',  # Планируемая процедура
            r'чем себя',  # Запрос о защите/поддержке
        ]

        for case in special_cases:
            if re.search(case, question_lower):
                logger.debug(f"Специальный случай: {case}")
                # Даже если мало медицинских терминов, считаем медицинским
                if medical_score >= 1:
                    return True

        # 8. Если есть слова "боль", "заболевание", "симптом" - считаем медицинским
        strong_indicators = ['боль', 'заболеван', 'симптом', 'лечен', 'терапи']
        if any(indicator in question_lower for indicator in strong_indicators):
            logger.debug(f"Принято по сильным индикаторам")
            return True

        logger.debug(f"Вопрос не медицинский: score={medical_score}, context={has_context}")
        logger.debug(f"Найденные паттерны: {found_patterns}")
        return False

    def extract_keywords(self, question: str) -> list:
        """Извлекает ключевые слова из вопроса"""
        question_lower = question.lower()
        keywords = []

        for pattern in self.medical_patterns:
            if pattern in question_lower:
                keywords.append(pattern)

        # Также ищем триггеры
        for pattern in self.trigger_patterns:
            if re.search(pattern, question_lower):
                # Извлекаем найденное слово
                match = re.search(pattern, question_lower)
                if match:
                    keywords.append(match.group())

        # Добавляем процедуры
        for procedure in self.medical_procedures:
            if procedure in question_lower:
                keywords.append(procedure)

        return list(set(keywords))  # Убираем дубли

    # ВАЖНО: Метод должен называться process
    def process(self, question: str) -> dict:
        """Обрабатывает вопрос с расширенной логикой"""
        cleaned = self.clean_question(question)
        is_medical = self.is_health_related(cleaned)
        keywords = self.extract_keywords(cleaned)

        logger.info("=" * 50)
        logger.info(f"Обработка вопроса:")
        logger.info(f"Оригинал: '{question[:100]}...'")
        logger.info(f"Очищенный: '{cleaned[:100]}...'")
        logger.info(f"Медицинский: {is_medical}")
        logger.info(f"Ключевые слова: {keywords}")
        logger.info("=" * 50)

        return {
            "original": question,
            "cleaned": cleaned,
            "is_medical": is_medical,
            "keywords": keywords,
            "error": None if is_medical else "Вопрос не распознан как медицинский"
        }